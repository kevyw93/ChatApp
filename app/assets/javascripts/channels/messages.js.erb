
$(document).on('turbolinks:load', function (){
  submitNewMessage();
});

<% ChatRoom.all.each do |chatroom| %>
  App['room' + <%=chatroom.id%>] = App.cable.subscriptions.create({channel: 'MessagesChannel', room: <%=chatroom.id%>}, {
    received: function(data){
      $("[data-chat-room='" + this.chatroomId + " ']").removeClass("hidden")
      return $("[data-chat-room='" + this.chatroomId + "']").append(data.message);
    },

    setChatroomId: function(chatroomId) {
      this.chatroomId = chatroomId
    }
  })
  <% end %>

function submitNewMessage(){
  $('textarea#message_content').keydown(function(event){
    if(event.keyCode === 13){
      var msg = event.target.value
      var chatroomId = $("[data-chat-room]").data().chat_room
      App.messages.send({message:msg, chat_room_id: chatroomId})
      $('[data-textarea="message"]').val(" ")
      return false;
    }
  });
}
